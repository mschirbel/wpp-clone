<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carregando...</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <main class="page">
    <section class="phone" aria-label="App Clone">
      <div id="home"></div>

      <input class="tab-input" type="radio" name="tab" id="tab-chats" checked />
      <input class="tab-input" type="radio" name="tab" id="tab-archived" />
      <input class="tab-input" type="radio" name="tab" id="tab-calls" />

      <header class="topbar">
        <div class="topbar__title">
          <span class="app-dot" aria-hidden="true"></span>
          <div>
            <h1 id="app-name">App</h1>
            <p class="subtitle" id="app-status">...</p>
          </div>
        </div>
        <div class="topbar__actions">
          <button class="icon-btn">‚åï</button>
          <button class="icon-btn">‚ãÆ</button>
        </div>
      </header>

      <div class="search">
        <span class="search__icon">‚åï</span>
        <input class="search__input" type="text" placeholder="Pesquisar" />
      </div>

      <section class="content">

        <div class="screen screen--chats">
          <div class="section-head">
            <h2>Chats</h2>
            <span class="badge" id="badge-chats">0</span>
          </div>
          <div class="list" id="list-chats"></div>
        </div>

        <div class="screen screen--archived">
          <div class="section-head">
            <h2>Arquivados</h2>
            <span class="badge badge--subtle" id="badge-archived">0</span>
          </div>
          <div class="list" id="list-archived"></div>
        </div>

        <div class="screen screen--calls">
          <div class="section-head">
            <h2>Calls</h2>
            <span class="badge badge--subtle" id="badge-calls">0</span>
          </div>
          <div class="list" id="list-calls"></div>
        </div>
      </section>

      <nav class="bottomnav">
        <label class="tab" for="tab-chats">
          <span class="tab__icon">üí¨</span><span class="tab__text">Chats</span>
        </label>
        <label class="tab" for="tab-archived">
          <span class="tab__icon">üóÑÔ∏è</span><span class="tab__text">Archived</span>
        </label>
        <label class="tab" for="tab-calls">
          <span class="tab__icon">üìû</span><span class="tab__text">Calls</span>
        </label>
      </nav>

      <div id="chat-views-container"></div>

    </section>
  </main>

  <script>
    // Utilit√°rio para criar IDs seguros
    const createId = (name) => 'chat-' + name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();

    // Fun√ß√£o Principal de Carregamento
    async function initApp() {
      try {
        // 1. Carrega Configura√ß√µes Gerais
        const config = await fetch('config.json').then(r => r.json());
        applyConfig(config);

        // 2. Carrega Dados do Caso
        const [chatsData, callsData, archivedData, messagesData] = await Promise.all([
          fetch('chats.json').then(r => r.json()),
          fetch('calls.json').then(r => r.json()),
          fetch('archived.json').then(r => r.json()),
          fetch('messages.json').then(r => r.json())
        ]);

        // 3. Renderiza Listas
        renderList(chatsData.chats, 'list-chats', 'badge-chats');
        renderList(archivedData.archived, 'list-archived', 'badge-archived');
        renderCalls(callsData.calls);

        // 4. Renderiza Telas de Conversa (Junta Chats + Arquivados)
        const allConversations = [...chatsData.chats, ...archivedData.archived];
        renderChatViews(allConversations, messagesData.messages);

      } catch (error) {
        console.error("Erro ao carregar o jogo:", error);
        document.body.innerHTML = "<h2 style='color:white;text-align:center;margin-top:20px'>Erro ao carregar arquivos JSON.<br>Use um Local Server.</h2>";
      }
    }

    // Aplica configura√ß√µes do config.json
    function applyConfig(config) {
      document.title = config.pageTitle || "App Clone";
      document.getElementById('app-name').textContent = config.appName || "WhatsApp";
      document.getElementById('app-status').textContent = config.appStatus || "online";
      // Se quiser mudar cor via config (opcional)
      if (config.themeColor) {
        document.documentElement.style.setProperty('--app-color', config.themeColor);
      }
    }

    // Renderiza Listas (Chats e Arquivados usam a mesma estrutura)
    function renderList(items, containerId, badgeId) {
      const container = document.getElementById(containerId);
      const badge = document.getElementById(badgeId);

      if (badge) badge.textContent = items ? items.length : 0;
      if (!items) return;

      items.forEach(item => {
        const chatId = createId(item.name);
        const initial = item.name.charAt(0);

        let pillHtml = '';
        if (item.muted) pillHtml = `<span class="pill pill--muted">M</span>`;
        else if (item.unread > 0) pillHtml = `<span class="pill">${item.unread}</span>`;

        const html = `
            <a class="row row--chat row-link" href="#${chatId}">
              <div class="avatar" data-initial="${initial}">
                 ${item.photo ? `<img src="${item.photo}" class="avatar-img" onerror="this.style.display='none'">` : ''}
              </div>
              <div class="row__main">
                <div class="row__top">
                  <strong>${item.name}</strong>
                  <span class="meta">${item.time}</span>
                </div>
                <div class="row__bottom">
                  <span class="preview">${item.lastMessage}</span>
                  ${pillHtml}
                </div>
              </div>
            </a>
          `;
        container.innerHTML += html;
      });
    }

    // Renderiza Chamadas
    function renderCalls(calls) {
      const container = document.getElementById('list-calls');
      document.getElementById('badge-calls').textContent = calls ? calls.length : 0;
      if (!calls) return;

      calls.forEach(call => {
        const initial = call.nameOrNumber.charAt(0);
        const icon = call.direction === 'out' ? '‚Üó' : '‚Üô';
        const typeClass = call.direction === 'out' ? 'call-tag--out' : 'call-tag--in';
        const statusText = call.status === 'missed' ? 'N√£o atendida' : (call.duration || 'Cancelada');

        const html = `
            <div class="row row--call">
              <div class="avatar avatar--call" data-initial="${initial}"></div>
              <div class="row__main">
                <div class="row__top">
                  <strong>${call.nameOrNumber}</strong>
                  <span class="meta">${call.time}</span>
                </div>
                <div class="row__bottom">
                  <span class="preview">
                    <span class="call-tag ${typeClass}">${icon}</span>
                    ${call.direction === 'in' ? 'Entrada' : 'Sa√≠da'} ‚Ä¢ ${statusText}
                  </span>
                  <span class="call-icon">üìû</span>
                </div>
              </div>
            </div>
          `;
        container.innerHTML += html;
      });
    }

    // Renderiza as Telas de Conversa (Views)
    function renderChatViews(list, messagesData) {
      const container = document.getElementById('chat-views-container');
      if (!list) return;

      list.forEach(chat => {
        const chatId = createId(chat.name);
        const initial = chat.name.charAt(0);
        const msgs = messagesData[chat.name] || [];

        let msgsHtml = '';

        if (msgs.length === 0) {
          msgsHtml = `<div class="dayline"><span>In√≠cio da conversa criptografada</span></div>`;
        } else {
          msgs.forEach(m => {
            if (m.type === 'dayline') {
              msgsHtml += `<div class="dayline"><span>${m.text}</span></div>`;
            } else {
              msgsHtml += `<div class="bubble bubble--${m.type}">${m.text} <span class="time">${m.time}</span></div>`;
            }
          });
        }

        const html = `
            <section id="${chatId}" class="chatview" aria-label="Conversa com ${chat.name}">
              <header class="chatbar">
                <a class="back" href="#home">‚Äπ</a>
                <div class="chatbar__who">
                  <div class="avatar avatar--small" data-initial="${initial}">
                    ${chat.photo ? `<img src="${chat.photo}" class="avatar-img" onerror="this.style.display='none'">` : ''}
                  </div>
                  <div>
                    <strong>${chat.name}</strong>
                    <div class="chatbar__sub">online</div>
                  </div>
                </div>
                <div class="chatbar__actions">
                  <button class="icon-btn">üìû</button>
                  <button class="icon-btn">‚ãÆ</button>
                </div>
              </header>

              <div class="chatmessages">
                ${msgsHtml}
              </div>

              <footer class="chatinput">
                <button class="chip">üôÇ</button>
                <input class="chatinput__field" type="text" placeholder="Mensagem" readonly />
                <button class="chip chip--send">‚û§</button>
              </footer>
            </section>
          `;
        container.innerHTML += html;
      });
    }

    // Inicia a aplica√ß√£o
    initApp();
  </script>
</body>

</html>